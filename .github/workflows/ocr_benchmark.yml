name: OCR Benchmark

on:
  workflow_dispatch:
    inputs:
      images_folder:
        description: 'R2 folder with images (r2://bucket/path/)'
        required: true
        type: string
      gt_folder:
        description: 'R2 folder with ground truth JSONs'
        required: true
        type: string
      model:
        description: 'OCR model'
        required: true
        default: 'doctr'
        type: choice
        options: [doctr, surya, paddle]
      compare_model:
        description: 'Second model (optional)'
        required: false
        type: choice
        options: ['', doctr, surya, paddle]
      runner_label:
        description: 'Runner label (e.g. ubuntu-latest, self-hosted)'
        required: true
        default: 'ubuntu-latest'
        type: string

env:
  RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  OCR_ENDPOINT_URL: ${{ secrets.OCR_ENDPOINT_URL }}
  R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
  R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
  OMP_NUM_THREADS: 1
  MKL_NUM_THREADS: 1

jobs:
  benchmark:
    runs-on: ${{ inputs.runner_label }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          if [ "${{ inputs.model }}" = "paddle" ] || [ "${{ inputs.compare_model }}" = "paddle" ]; then
            pip install paddleocr paddlepaddle
          fi
      
      - name: Configure R2
        run: |
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc && sudo mv mc /usr/local/bin/
          mc alias set r2 "$R2_ENDPOINT" "$R2_ACCESS_KEY" "$R2_SECRET_KEY"
          
      - name: Debug R2 Structure
        run: |
          echo "Listing bucket root..."
          mc ls r2/aiexperiments/ || true
          echo "Listing recursively to find correct path..."
          mc ls -r r2/aiexperiments/ | head -n 20 || true
      
      - name: Run Batch OCR
        run: |
          mkdir -p outputs
          CMD="python scripts/run_batch_ocr.py"
          CMD="$CMD --images-folder '${{ inputs.images_folder }}'"
          CMD="$CMD --gt-folder '${{ inputs.gt_folder }}'"
          CMD="$CMD --model '${{ inputs.model }}'"
          CMD="$CMD --output-dir outputs"
          CMD="$CMD --output-json outputs/results.json"
          CMD="$CMD --output-summary outputs/summary.txt"
          [ -n "${{ inputs.compare_model }}" ] && CMD="$CMD --compare-model '${{ inputs.compare_model }}'"
          eval $CMD
      
      - name: Generate HTML Report
        run: |
          python scripts/generate_batch_html_report.py \
            --results-json outputs/results.json \
            --output outputs/report.html \
            --run-number "${{ github.run_number }}" || true
      
      - name: Upload Report to R2
        run: |
          # Robustly handle r2:// or r2/ prefix
          CLEAN_PATH=$(echo "${{ inputs.images_folder }}" | sed -E 's|^r2://||; s|^r2/||')
          BUCKET=$(echo "$CLEAN_PATH" | cut -d'/' -f1)
          
          REPORT_PATH="reports/run-${{ github.run_number }}/report.html"
          
          # Upload using the alias 'r2' defined in configure step
          mc cp outputs/report.html "r2/$BUCKET/$REPORT_PATH" || true
          
          # Generate presigned URL
          REPORT_URL=$(mc share download --expire=168h "r2/$BUCKET/$REPORT_PATH" 2>/dev/null | grep -o 'https://[^ ]*' | head -1) || true
          
          if [ -n "$REPORT_URL" ]; then
             echo "### ðŸ“Š [View Report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Summary
        run: |
          echo "## OCR Batch Results" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat outputs/summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - uses: actions/upload-artifact@v4
        with:
          name: ocr-outputs-${{ github.run_number }}
          path: outputs/
          retention-days: 30
