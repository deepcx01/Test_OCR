name: OCR Benchmark

on:
  workflow_dispatch:
    inputs:
      images_folder:
        description: 'R2 folder with images (r2://bucket/path/)'
        required: true
        type: string
      gt_folder:
        description: 'R2 folder with ground truth JSONs'
        required: true
        type: string
      model:
        description: 'OCR model'
        required: true
        default: 'doctr'
        type: choice
        options: [doctr, surya, paddle]
      compare_model:
        description: 'Second model (optional)'
        required: false
        type: choice
        options: ['', doctr, surya, paddle]

env:
  RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  OCR_ENDPOINT_URL: ${{ secrets.OCR_ENDPOINT_URL }}
  R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
  R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          if [ "${{ inputs.model }}" = "paddle" ] || [ "${{ inputs.compare_model }}" = "paddle" ]; then
            pip install paddleocr paddlepaddle
          fi
      
      - name: Configure R2
        run: |
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc && sudo mv mc /usr/local/bin/
          mc alias set r2 "$R2_ENDPOINT" "$R2_ACCESS_KEY" "$R2_SECRET_KEY"
      
      - name: Run Batch OCR
        run: |
          mkdir -p outputs
          CMD="python scripts/run_batch_ocr.py"
          CMD="$CMD --images-folder '${{ inputs.images_folder }}'"
          CMD="$CMD --gt-folder '${{ inputs.gt_folder }}'"
          CMD="$CMD --model '${{ inputs.model }}'"
          CMD="$CMD --output-dir outputs"
          CMD="$CMD --output-json outputs/results.json"
          CMD="$CMD --output-summary outputs/summary.txt"
          [ -n "${{ inputs.compare_model }}" ] && CMD="$CMD --compare-model '${{ inputs.compare_model }}'"
          eval $CMD
      
      - name: Generate HTML Report
        run: |
          python scripts/generate_batch_html_report.py \
            --results-json outputs/results.json \
            --output outputs/report.html \
            --run-number "${{ github.run_number }}" || true
      
      - name: Upload Report to R2
        run: |
          BUCKET=$(echo "${{ inputs.images_folder }}" | sed 's|r2://||' | cut -d'/' -f1)
          REPORT_PATH="reports/run-${{ github.run_number }}/report.html"
          mc cp outputs/report.html r2/$BUCKET/$REPORT_PATH || true
          REPORT_URL=$(mc share download --expire=168h r2/$BUCKET/$REPORT_PATH 2>/dev/null | grep -o 'https://[^ ]*' | head -1) || true
          [ -n "$REPORT_URL" ] && echo "### ðŸ“Š [View Report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
      
      - name: Summary
        run: |
          echo "## OCR Batch Results" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat outputs/summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - uses: actions/upload-artifact@v4
        with:
          name: ocr-outputs-${{ github.run_number }}
          path: outputs/
          retention-days: 30
